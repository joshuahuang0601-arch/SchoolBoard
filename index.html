<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SchoolBoard Forum</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
body { background: linear-gradient(to bottom right, #eef2ff, #f5f3ff, #faf5ff); min-height:100vh; }
.fade { transition: opacity 0.4s ease; }
.hidden { display: none; }
.reply { margin-left: 1rem; border-left: 2px solid #ddd; padding-left:0.5rem; margin-top:0.5rem; }
.cursor-pointer { cursor: pointer; }
.collapse-toggle { font-size:0.8rem; color:#555; cursor:pointer; margin-left:0.5rem; }
.user-info { font-size: 0.8rem; color:#555; }
.post-actions i { cursor: pointer; }
.reply-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
.reply-container.expanded { max-height: 2000px; }
</style>
</head>
<body class="min-h-screen">

<!-- Forum Page -->
<div id="forumPage" class="max-w-6xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6">SchoolBoard Forum</h1>
  <div class="mb-6">
    <input id="topicName" placeholder="Topic name" class="w-full px-4 py-2 border rounded-lg mb-2">
    <textarea id="topicDesc" placeholder="Optional description" rows="2" class="w-full px-4 py-2 border rounded-lg mb-2"></textarea>
    <button id="createTopicBtn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700">Create Topic</button>
  </div>
  <div id="forumContainer" class="space-y-4"></div>
</div>

<!-- Topic Page -->
<div id="topicPage" class="hidden max-w-6xl mx-auto px-4 py-8">
  <button id="backToForumBtn" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 flex items-center gap-2">&larr; Back</button>
  <h2 id="topicPageName" class="text-xl font-bold mt-4"></h2>
  <p id="topicPageDesc" class="text-gray-600 mb-4"></p>
  <textarea id="newPostContent" placeholder="Write your post..." rows="3" class="w-full px-4 py-2 border rounded-lg mb-2"></textarea>
  <button id="postBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Post</button>
  <div id="postsContainer" class="space-y-3 mt-4"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DATABASE_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
let currentUser = null;
let topicsCache = {};
let currentTopicId = null;
let currentUserName = 'User' + Math.floor(Math.random()*10000);

signInAnonymously(auth).then(u=>{ currentUser = u.user; initRealtime(); }).catch(console.error);

const forumContainer = document.getElementById('forumContainer');
const topicPage = document.getElementById('topicPage');
const forumPage = document.getElementById('forumPage');
const topicPageName = document.getElementById('topicPageName');
const topicPageDesc = document.getElementById('topicPageDesc');
const postsContainer = document.getElementById('postsContainer');

function initRealtime(){
  onValue(ref(db,'topics'),snap=>{ topicsCache = snap.val()||{}; renderForum(); if(currentTopicId) renderTopicPage(currentTopicId); });
}

function renderForum(){
  forumContainer.innerHTML='';
  Object.entries(topicsCache).forEach(([id,t])=>{
    const div = document.createElement('div');
    div.className='bg-white p-4 rounded-lg shadow cursor-pointer';
    div.innerHTML=`<h3 class='font-bold'>${t.topicName}</h3><p class='text-gray-500 text-sm'>${t.description||''}</p>`;
    div.addEventListener('click',()=>{ currentTopicId=id; forumPage.classList.add('hidden'); topicPage.classList.remove('hidden'); renderTopicPage(id); });
    forumContainer.appendChild(div);
  });
}

function renderTopicPage(topicId){
  const topic = topicsCache[topicId];
  topicPageName.innerText = topic.topicName;
  topicPageDesc.innerText = topic.description||'';
  postsContainer.innerHTML='';
  if(topic.posts){ Object.entries(topic.posts).forEach(([pid,p])=>{ renderPostRecursive({...p,id:pid},postsContainer,topicId); }); }
}

function renderPostRecursive(post,parentElem,topicId){
  const div = document.createElement('div');
  div.className='bg-gray-50 p-3 rounded shadow mt-2';
  div.innerHTML=`
    <div class='flex justify-between'>
      <div>${post.authorName||'Anonymous'}<br><span class='text-gray-400 text-sm'>${new Date(post.timestamp||0).toLocaleString()}</span></div>
      <div class='flex gap-2'><i data-lucide='thumbs-up' class='w-5 h-5 ${post.likes&&post.likes[currentUser.uid]?'text-blue-600':'text-gray-400'}'></i><span class='likes-count'>${post.likes?Object.keys(post.likes).length:0}</span></div>
    </div>
    <div class='mt-2'>${post.content}</div>
    <div id='replies-${post.id}' class='reply-container'></div>
  `;
  parentElem.appendChild(div);
  lucide.createIcons();

  const thumbsUp = div.querySelector('i[data-lucide="thumbs-up"]');
  thumbsUp.addEventListener('click',e=>{
    e.stopPropagation();
    const likeRef = ref(db,`topics/${currentTopicId}/posts/${post.id}/likes/${currentUser.uid}`);
    likeRef.transaction(current=>current?null:true);
  });

  const repliesEl = div.querySelector(`#replies-${post.id}`);
  if(post.replies){ Object.entries(post.replies).forEach(([rid,rp])=>{ renderReplyRecursive({...rp,id:rid},repliesEl,topicId,post.id,1); }); }
}

function renderReplyRecursive(reply,parentElem,topicId,parentPostId,level){
  const div = document.createElement('div');
  div.className='bg-gray-50 p-3 rounded shadow mt-2';
  div.style.marginLeft = `${level}rem`;
  div.innerHTML=`
    <div class='flex justify-between'>
      <div>${reply.authorName||'Anonymous'}<br><span class='text-gray-400 text-sm'>${new Date(reply.timestamp||0).toLocaleString()}</span></div>
      <div class='flex gap-2'><i data-lucide='thumbs-up' class='w-5 h-5 ${reply.likes&&reply.likes[currentUser.uid]?'text-blue-600':'text-gray-400'}'></i><span class='likes-count'>${reply.likes?Object.keys(reply.likes).length:0}</span></div>
    </div>
    <div class='mt-2'>${reply.content}</div>
    <div id='replies-${reply.id}' class='reply-container'></div>
  `;
  parentElem.appendChild(div);
  lucide.createIcons();

  const thumbsUp = div.querySelector('i[data-lucide="thumbs-up"]');
  thumbsUp.addEventListener('click',e=>{
    e.stopPropagation();
    const likeRef = ref(db,`topics/${currentTopicId}/posts/${parentPostId}/replies/${reply.id}/likes/${currentUser.uid}`);
    likeRef.transaction(current=>current?null:true);
  });

  const repliesEl = div.querySelector(`#replies-${reply.id}`);
  if(reply.replies){ Object.entries(reply.replies).forEach(([rid,rp])=>{ renderReplyRecursive({...rp,id:rid},repliesEl,topicId,parentPostId,level+1); }); }
}

// 发帖
document.getElementById('postBtn').addEventListener('click',()=>{
  const val = document.getElementById('newPostContent').value.trim();
  if(!val) return;
  push(ref(db,`topics/${currentTopicId}/posts`),{ authorName: currentUserName, authorUid: currentUser.uid, content: val, timestamp: Date.now() });
  document.getElementById('newPostContent').value='';
});

// 返回论坛
document.getElementById('backToForumBtn').addEventListener('click',()=>{
  topicPage.classList.add('hidden'); forumPage.classList.remove('hidden'); currentTopicId=null;
});

// 创建话题
document.getElementById('createTopicBtn').addEventListener('click',()=>{
  const name=document.getElementById('topicName').value.trim();
  const desc=document.getElementById('topicDesc').value.trim();
  if(!name) return;
  push(ref(db,'topics'),{topicName:name,description:desc,authorUid:currentUser.uid,timestamp:Date.now()});
  document.getElementById('topicName').value='';
  document.getElementById('topicDesc').value='';
});
</script>
</body>
</html>
