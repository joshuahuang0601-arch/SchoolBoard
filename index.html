<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SchoolBoard - Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { background: linear-gradient(to bottom right, #eef2ff, #f5f3ff, #faf5ff); min-height: 100vh; overflow-x: hidden; }
    .fade { transition: opacity 0.45s ease; }
    .hidden { display: none; }
  </style>
</head>
<body class="min-h-screen">

<!-- Welcome -->
<div id="welcome-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 fade z-40">
  <h1 class="text-5xl font-bold text-indigo-700 select-none mb-4">Welcome to SchoolBoard!</h1>
  <p class="text-gray-600 text-lg animate-pulse">Click anywhere to enter</p>
</div>

<!-- Main App -->
<div id="app" class="hidden fade opacity-0">

  <header class="bg-white shadow-md">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i data-lucide="message-square" class="text-indigo-600 w-8 h-8"></i>
        <div>
          <h1 class="text-2xl font-bold text-gray-800">SchoolBoard</h1>
          <p class="text-gray-500 text-sm">Forum — your school community hub</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="draftsBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 flex items-center gap-2">
          <i data-lucide="archive" class="w-4 h-4"></i> Drafts
        </button>
        <div id="userTag" class="text-sm text-gray-600"></div>
      </div>
    </div>
  </header>

  <!-- Post editor -->
  <div class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Create a Forum Post</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
        <input id="author" placeholder="Your name" class="col-span-1 md:col-span-1 px-4 py-2 border rounded-lg" />
        <input id="title" placeholder="Title" class="col-span-1 md:col-span-2 px-4 py-2 border rounded-lg" />
      </div>
      <textarea id="contentText" placeholder="Write your message..." rows="4" class="w-full px-4 py-3 border rounded-lg mb-3 resize-none"></textarea>
      <div class="flex items-center gap-3">
        <button id="postBtn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700">Post</button>
        <button id="saveDraftBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Save Draft</button>
        <span id="editorStatus" class="text-sm text-gray-500 ml-3"></span>
      </div>
    </div>

    <!-- Search -->
    <div class="relative">
      <i data-lucide="search" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
      <input id="search" type="text" placeholder="Search..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
    </div>

    <!-- Posts -->
    <div id="content" class="space-y-6"></div>
  </div>
</div>

<!-- Drafts panel -->
<div id="draftsPanel" class="fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-lg z-50 transform translate-x-full transition-transform duration-300">
  <div class="p-4 border-b flex items-center justify-between">
    <h3 class="text-lg font-semibold">Your Drafts</h3>
    <div class="flex items-center gap-2">
      <button id="newDraftBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700">New</button>
      <button id="closeDrafts" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>
  </div>
  <div class="p-4 overflow-auto h-[calc(100vh-72px)]">
    <div id="draftsList" class="space-y-3"></div>
    <div id="emptyDrafts" class="text-gray-500 text-center py-8"><i data-lucide="file-text" class="w-10 h-10 mx-auto text-gray-300"></i><p class="mt-3">No drafts yet.</p></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyARjDy8wyvqgGFv0pEFXiSUHbw0_9srVEk",
  authDomain: "schoolboard-942bc.firebaseapp.com",
  databaseURL: "https://schoolboard-942bc-default-rtdb.firebaseio.com",
  projectId: "schoolboard-942bc",
  storageBucket: "schoolboard-942bc.firebasestorage.app",
  messagingSenderId: "530189085355",
  appId: "1:530189085355:web:6d2706eb965a7c5bf125ee"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// DOM
const welcome = document.getElementById('welcome-screen');
const appRoot = document.getElementById('app');
const draftsBtn = document.getElementById('draftsBtn');
const draftsPanel = document.getElementById('draftsPanel');
const closeDrafts = document.getElementById('closeDrafts');
const draftsList = document.getElementById('draftsList');
const emptyDrafts = document.getElementById('emptyDrafts');
const newDraftBtn = document.getElementById('newDraftBtn');
const postBtn = document.getElementById('postBtn');
const saveDraftBtn = document.getElementById('saveDraftBtn');
const authorInput = document.getElementById('author');
const titleInput = document.getElementById('title');
const contentInput = document.getElementById('contentText');
const contentContainer = document.getElementById('content');
const searchInput = document.getElementById('search');
const editorStatus = document.getElementById('editorStatus');
const userTag = document.getElementById('userTag');

let currentUser=null;
let currentEditingDraftId=null;
let draftsCache={};
let postsCache={};
const postsPath="posts/forum";
function draftsBasePath(uid){return `drafts/${uid}`;}

// Utils
function timeAgo(ts){const diff=Math.floor((Date.now()-ts)/1000);if(diff<60) return "Just now"; if(diff<3600) return `${Math.floor(diff/60)} minutes ago`; if(diff<86400) return `${Math.floor(diff/3600)} hours ago`; return `${Math.floor(diff/86400)} days ago`;}
function escapeHtml(str){if(!str) return ""; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;").replaceAll("\n","<br/>");}

// ---------- Auth with fixed UID ----------
let storedUid=localStorage.getItem('anonUid');
if(!storedUid){
  signInAnonymously(auth).then(u=>{
    storedUid=u.user.uid;
    localStorage.setItem('anonUid',storedUid);
    currentUser=u.user;
    userTag.innerText=`User: ${storedUid.slice(0,8)}`;
    initRealtime();
  }).catch(console.error);
}else{
  currentUser={uid:storedUid};
  userTag.innerText=`User: ${storedUid.slice(0,8)}`;
  initRealtime();
}

// ---------- Welcome click ----------
lucide.createIcons();
welcome.addEventListener('click',()=>{
  welcome.style.opacity=0;
  setTimeout(()=>{
    welcome.remove();
    appRoot.classList.remove('hidden');
    appRoot.style.opacity=1;
    lucide.createIcons();
  },400);
});

// ---------- Drafts panel ----------
draftsBtn.addEventListener('click',()=>{draftsPanel.style.transform='translateX(0)';loadUserDrafts();});
closeDrafts.addEventListener('click',()=>{draftsPanel.style.transform='translateX(100%)';});
newDraftBtn.addEventListener('click',()=>{
  currentEditingDraftId=null;
  authorInput.value='';
  titleInput.value='';
  contentInput.value='';
  editorStatus.innerText="New draft - unsaved";
});

// ---------- Realtime ----------
function initRealtime(){
  onValue(ref(db,postsPath),snap=>{postsCache=snap.val()||{};renderPosts(Object.entries(postsCache).map(([id,p])=>({id,...p})));});
  if(currentUser) loadUserDrafts();
}

// ---------- Render Forum ----------
function renderPosts(arr){
  arr.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
  const q=searchInput.value.trim().toLowerCase();
  const filtered=arr.filter(p=>{
    if(!q) return true;
    return (p.title||"").toLowerCase().includes(q)||(p.content||"").toLowerCase().includes(q)||(p.author||"").toLowerCase().includes(q);
  });
  contentContainer.innerHTML=filtered.map(p=>{
    const comments=p.comments?Object.entries(p.comments).map(([cid,c])=>({id:cid,...c})):[];  
    const commentsHtml=comments.length>0?comments.map(c=>`<div class="mt-2"><div class="flex items-baseline gap-2"><span class="font-medium text-gray-700">${escapeHtml(c.author)}</span><span class="text-sm text-gray-400 ml-1">${timeAgo(c.timestamp||0)}</span></div><div class="text-gray-600">${escapeHtml(c.content)}</div></div>`).join(""):`<p class="text-gray-400 text-sm">No comments yet.</p>`;
    return `<div class="bg-white p-4 rounded-lg shadow mb-6"><div class="flex justify-between mb-1"><span class="font-semibold text-gray-800">${escapeHtml(p.author||"Anonymous")}</span><span class="text-sm text-gray-500">${timeAgo(p.timestamp||0)}</span></div><h3 class="font-bold text-lg text-gray-900">${escapeHtml(p.title||"(no title)")}</h3><p class="text-gray-700 mt-1 mb-3">${escapeHtml(p.content||"")}</p><div class="pl-4 border-l-4 border-indigo-100">${commentsHtml}<div class="mt-3 flex gap-2"><input id="comment-author-${p.id}" placeholder="Your name" class="flex-1 px-2 py-1 border rounded"><input id="comment-content-${p.id}" placeholder="Add a comment..." class="flex-1 px-2 py-1 border rounded"><button data-post="${p.id}" class="comment-btn bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">Comment</button></div></div></div>`;
  }).join("");
  document.querySelectorAll('.comment-btn').forEach(btn=>{btn.onclick=e=>{const pid=e.currentTarget.dataset.post;const a=document.getElementById(`comment-author-${pid}`).value.trim();const c=document.getElementById(`comment-content-${pid}`).value.trim();if(!a||!c)return alert("Enter name & comment");push(ref(db,`${postsPath}/${pid}/comments`),{author:a,content:c,timestamp:Date.now()}).then(()=>{document.getElementById(`comment-author-${pid}`).value="";document.getElementById(`comment-content-${pid}`).value="";});}});
  lucide.createIcons();
}

// ---------- Post & Save Draft ----------
postBtn.addEventListener('click',()=>{
  const a=authorInput.value.trim()||"Anonymous", t=titleInput.value.trim(), c=contentInput.value.trim();
  if(!t||!c) return alert("Please fill in a title and content.");
  push(ref(db,postsPath),{author:a,title:t,content:c,timestamp:Date.now()}).then(()=>{
    if(currentEditingDraftId) remove(ref(db,`${draftsBasePath(currentUser.uid)}/${currentEditingDraftId}`));
    currentEditingDraftId=null;authorInput.value="";titleInput.value="";contentInput.value="";editorStatus.innerText="Posted";
  });
});
saveDraftBtn.addEventListener('click',()=>{
  const a=authorInput.value.trim(), t=titleInput.value.trim(), c=contentInput.value.trim();
  if(!a&&!t&&!c) return alert("Draft empty");
  const base=draftsBasePath(currentUser.uid);
  if(currentEditingDraftId){
    update(ref(db,`${base}/${currentEditingDraftId}`),{author:a,title:t,content:c,timestamp:Date.now()}).then(()=>editorStatus.innerText="Draft updated");
  }else{
    push(ref(db,base),{author:a,title:t,content:c,timestamp:Date.now()}).then(()=>editorStatus.innerText="Draft saved");
  }
});

// ---------- Load Drafts ----------
function loadUserDrafts(){
  onValue(ref(db,draftsBasePath(currentUser.uid)),snap=>{draftsCache=snap.val()||{};renderDraftsList();});
}
function renderDraftsList(){
  const entries=Object.entries(draftsCache||{});
  if(entries.length===0){draftsList.innerHTML="";emptyDrafts.style.display="block";return;}
  emptyDrafts.style.display="none";
  draftsList.innerHTML=entries.sort((a,b)=>b[1].timestamp-a[1].timestamp).map(([id,d])=>`<div class="border rounded p-3"><div class="flex justify-between items-start gap-2"><div><div class="font-medium text-gray-800">${escapeHtml(d.title||"(no title)")}</div><div class="text-gray-500 text-sm">${escapeHtml(d.author||"Anonymous")} · ${timeAgo(d.timestamp||0)}</div></div><div class="flex gap-2"><button data-id="${id}" class="edit-draft px-2 py-1 bg-yellow-100 rounded hover:bg-yellow-200 text-sm">Edit</button><button data-id="${id}" class="publish-draft px-2 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">Publish</button><button data-id="${id}" class="delete-draft px-2 py-1 bg-red-100 rounded hover:bg-red-200 text-sm">Delete</button></div></div><div class="text-gray-700 mt-2">${escapeHtml((d.content||"").slice(0,200))}${(d.content||"").length>200?"...":""}</div></div>`).join("");
  draftsList.querySelectorAll('.edit-draft').forEach(btn=>btn.onclick=e=>{const id=e.currentTarget.dataset.id;const d=draftsCache[id];currentEditingDraftId=id;authorInput.value=d.author||"";titleInput.value=d.title||"";contentInput.value=d.content||"";editorStatus.innerText="Editing draft";});
  draftsList.querySelectorAll('.publish-draft').forEach(btn=>btn.onclick=e=>{const id=e.currentTarget.dataset.id;const d=draftsCache[id];push(ref(db,postsPath),{author:d.author,title:d.title,content:d.content,timestamp:Date.now()}).then(()=>remove(ref(db,`${draftsBasePath(currentUser.uid)}/${id}`)).then(()=>{currentEditingDraftId=null;authorInput.value="";titleInput.value="";contentInput.value="";editorStatus.innerText="Posted";}));});
  draftsList.querySelectorAll('.delete-draft').forEach(btn=>btn.onclick=e=>{const id=e.currentTarget.dataset.id;if(confirm("Delete draft?")) remove(ref(db,`${draftsBasePath(currentUser.uid)}/${id}`));});
  lucide.createIcons();
}

searchInput.addEventListener('input',()=>{renderPosts(Object.entries(postsCache||{}).map(([id,p])=>({id,...p})));});
</script>

</body>
</html>
