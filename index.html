<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SchoolBoard - Forum</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  body { background: linear-gradient(to bottom right, #eef2ff, #f5f3ff, #faf5ff); min-height:100vh; }
  .fade { transition: opacity 0.4s ease; }
  .hidden { display: none; }
  .panel { position: fixed; top:0; right:0; height:100%; width:100%; max-width:24rem; background:white; z-index:50; transform:translateX(100%); transition: transform 0.3s; }
</style>
</head>
<body class="min-h-screen">

<!-- Welcome -->
<div id="welcome-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 fade z-40">
  <h1 class="text-5xl font-bold text-indigo-700 select-none mb-4">Welcome to SchoolBoard!</h1>
  <p class="text-gray-600 text-lg animate-pulse">Click anywhere to enter</p>
</div>

<!-- Main App -->
<div id="app" class="hidden fade opacity-0">
  <header class="bg-white shadow-md">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i data-lucide="message-square" class="text-indigo-600 w-8 h-8"></i>
        <div>
          <h1 class="text-2xl font-bold text-gray-800">SchoolBoard</h1>
          <p class="text-gray-500 text-sm">Forum — your school community hub</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="draftsBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 flex items-center gap-2">
          <i data-lucide="archive" class="w-4 h-4"></i> Drafts
        </button>
        <button id="favoritesBtn" class="px-3 py-2 bg-yellow-400 text-white rounded-md hover:bg-yellow-500 flex items-center gap-2">
          <i data-lucide="star" class="w-4 h-4"></i> Favorites
        </button>
        <div id="userTag" class="text-sm text-gray-600"></div>
      </div>
    </div>
  </header>

  <div class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <!-- Create Topic -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Create New Topic</h2>
      <input id="topicName" placeholder="Topic name" class="w-full px-4 py-2 border rounded-lg mb-3">
      <button id="createTopicBtn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700">Create Topic</button>
    </div>

    <!-- Forum Topics -->
    <div id="forumContainer" class="space-y-4"></div>
  </div>
</div>

<!-- Drafts Panel -->
<div id="draftsPanel" class="panel">
  <div class="p-4 border-b flex items-center justify-between">
    <h3 class="text-lg font-semibold">Your Drafts</h3>
    <div class="flex items-center gap-2">
      <button id="newDraftBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700">New</button>
      <button id="closeDrafts" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>
  </div>
  <div class="p-4 overflow-auto h-[calc(100vh-72px)]">
    <div id="draftsList" class="space-y-3"></div>
    <div id="emptyDrafts" class="text-gray-500 text-center py-8"><i data-lucide="file-text" class="w-10 h-10 mx-auto text-gray-300"></i><p class="mt-3">No drafts yet.</p></div>
  </div>
</div>

<!-- Favorites Panel -->
<div id="favoritesPanel" class="panel">
  <div class="p-4 border-b flex items-center justify-between">
    <h3 class="text-lg font-semibold">Your Favorites</h3>
    <button id="closeFavorites" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"><i data-lucide="x" class="w-4 h-4"></i></button>
  </div>
  <div class="p-4 overflow-auto h-[calc(100vh-72px)]" id="favoritesList"></div>
</div>

<!-- Topic Modal -->
<div id="topicModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white w-full max-w-3xl mx-auto p-6 rounded-lg max-h-[90vh] overflow-auto">
    <div class="flex justify-between items-center mb-4">
      <h3 id="topicModalName" class="text-xl font-bold text-gray-800">Topic</h3>
      <button id="closeTopicModal" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>

    <!-- New Post -->
    <div class="mb-4">
      <textarea id="newPostContent" placeholder="Write your post..." rows="3" class="w-full px-4 py-2 border rounded-lg mb-2 resize-none"></textarea>
      <div class="flex gap-2">
        <button id="postBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Post</button>
        <button id="saveDraftBtn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg hover:bg-gray-300">Save Draft</button>
        <span id="editorStatus" class="text-sm text-gray-500 ml-2"></span>
      </div>
      <div id="deleteAllPostsContainer" class="mt-2 hidden">
        <button id="deleteAllPostsBtn" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">Delete All Posts (Topic Author)</button>
      </div>
    </div>

    <!-- Posts List -->
    <div id="postsContainer" class="space-y-3"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, set } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyARjDy8wyvqgGFv0pEFXiSUHbw0_9srVEk",
  authDomain: "schoolboard-942bc.firebaseapp.com",
  databaseURL: "https://schoolboard-942bc-default-rtdb.firebaseio.com",
  projectId: "schoolboard-942bc",
  storageBucket: "schoolboard-942bc.firebasestorage.app",
  messagingSenderId: "530189085355",
  appId: "1:530189085355:web:6d2706eb965a7c5bf125ee"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUser = null;
let topicsCache = {};
let favoritesCache = {};
let draftsCache = {};
let currentTopicId = null;
let currentEditingDraftId = null;

const welcome = document.getElementById('welcome-screen');
const appRoot = document.getElementById('app');
const forumContainer = document.getElementById('forumContainer');
const draftsBtn = document.getElementById('draftsBtn');
const draftsPanel = document.getElementById('draftsPanel');
const closeDrafts = document.getElementById('closeDrafts');
const draftsList = document.getElementById('draftsList');
const emptyDrafts = document.getElementById('emptyDrafts');
const newDraftBtn = document.getElementById('newDraftBtn');
const topicNameInput = document.getElementById('topicName');
const createTopicBtn = document.getElementById('createTopicBtn');
const userTag = document.getElementById('userTag');

const favoritesBtn = document.getElementById('favoritesBtn');
const favoritesPanel = document.getElementById('favoritesPanel');
const closeFavorites = document.getElementById('closeFavorites');
const favoritesList = document.getElementById('favoritesList');

const topicModal = document.getElementById('topicModal');
const topicModalName = document.getElementById('topicModalName');
const closeTopicModal = document.getElementById('closeTopicModal');
const newPostContent = document.getElementById('newPostContent');
const postBtn = document.getElementById('postBtn');
const saveDraftBtn = document.getElementById('saveDraftBtn');
const editorStatus = document.getElementById('editorStatus');
const postsContainer = document.getElementById('postsContainer');
const deleteAllPostsContainer = document.getElementById('deleteAllPostsContainer');
const deleteAllPostsBtn = document.getElementById('deleteAllPostsBtn');

function escapeHtml(str){return String(str||"").replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;").replaceAll("\n","<br/>");}
function timeAgo(ts){
  const diff=(Date.now()-ts)/1000;
  if(diff<60) return 'Just now';
  if(diff<3600) return Math.floor(diff/60)+'m ago';
  if(diff<86400) return Math.floor(diff/3600)+'h ago';
  return Math.floor(diff/86400)+'d ago';
}

// ---------- Auth ----------
let storedUid = localStorage.getItem('anonUid');
if(!storedUid){
  signInAnonymously(auth).then(u=>{
    storedUid = u.user.uid;
    localStorage.setItem('anonUid',storedUid);
    currentUser = u.user;
    userTag.innerText = `User: ${storedUid.slice(0,8)}`;
    initRealtime();
  }).catch(console.error);
}else{
  currentUser = {uid:storedUid};
  userTag.innerText = `User: ${storedUid.slice(0,8)}`;
  initRealtime();
}

// ---------- Welcome ----------
lucide.createIcons();
welcome.addEventListener('click',()=>{
  welcome.style.opacity=0;
  setTimeout(()=>{
    welcome.remove();
    appRoot.classList.remove('hidden');
    appRoot.style.opacity=1;
    lucide.createIcons();
  },400);
});

// ---------- Realtime ----------
function initRealtime(){
  onValue(ref(db,'topics'),snap=>{
    topicsCache = snap.val()||{};
    renderTopics();
    renderFavoritesPanel();
  });
  onValue(ref(db,`favorites/${currentUser.uid}`),snap=>{
    favoritesCache = snap.val()||{};
    renderTopics();
    renderFavoritesPanel();
  });
  onValue(ref(db,`drafts/${currentUser.uid}`),snap=>{
    draftsCache = snap.val()||{};
    renderDraftsList();
  });
}

// ---------- Render Topics ----------
function renderTopics(){
  const arr = Object.entries(topicsCache).map(([id,t])=>({id,...t}));
  arr.sort((a,b)=>{
    const aFav=favoritesCache[a.id]?1:0;
    const bFav=favoritesCache[b.id]?1:0;
    if(aFav!==bFav) return bFav-aFav;
    const aPosts=a.posts?Object.keys(a.posts).length:0;
    const bPosts=b.posts?Object.keys(b.posts).length:0;
    return bPosts-aPosts;
  });
  forumContainer.innerHTML = arr.map(t=>{
    const fav=favoritesCache[t.id]?true:false;
    return `<div class="bg-white p-4 rounded-lg shadow flex justify-between items-center cursor-pointer">
      <div class="flex-1" onclick="openTopic('${t.id}')">
        <h3 class="font-bold text-gray-800">${escapeHtml(t.topicName)}</h3>
        <p class="text-sm text-gray-500">by ${escapeHtml(t.author)}</p>
      </div>
      <button onclick="toggleFavorite(event,'${t.id}')" class="px-2 py-1 rounded ${fav?'bg-yellow-400':'bg-gray-200'}">⭐</button>
    </div>`;
  }).join('');
  lucide.createIcons();
}

// ---------- Favorites ----------
window.toggleFavorite=function(e,topicId){
  e.stopPropagation();
  const favRef = ref(db,`favorites/${currentUser.uid}/${topicId}`);
  if(favoritesCache[topicId]) remove(favRef);
  else set(favRef,true);
};

favoritesBtn.addEventListener('click',()=>{favoritesPanel.style.transform='translateX(0)'; renderFavoritesPanel();});
closeFavorites.addEventListener('click',()=>{favoritesPanel.style.transform='translateX(100%)';});

function renderFavoritesPanel(){
  const arr = Object.entries(favoritesCache||{}).map(([id])=>({id,...(topicsCache[id]||{})}));
  if(arr.length===0){favoritesList.innerHTML='<p class="text-gray-500 text-center py-8">No favorites yet.</p>'; return;}
  arr.sort((a,b)=>{const aPosts=a.posts?Object.keys(a.posts).length:0; const bPosts=b.posts?Object.keys(b.posts).length:0; return bPosts-aPosts;});
  favoritesList.innerHTML = arr.map(t=>{
    return `<div class="bg-white p-3 rounded shadow flex justify-between items-center cursor-pointer">
      <div class="flex-1" onclick="openTopic('${t.id}')">
        <h3 class="font-bold text-gray-800">${escapeHtml(t.topicName)}</h3>
        <p class="text-sm text-gray-500">by ${escapeHtml(t.author)}</p>
      </div>
      <button onclick="toggleFavorite(event,'${t.id}')" class="px-2 py-1 rounded bg-yellow-400">⭐</button>
    </div>`;
  }).join('');
  lucide.createIcons();
}

// ---------- Create Topic ----------
createTopicBtn.addEventListener('click',()=>{
  const name = topicNameInput.value.trim();
  if(!name) return alert("Enter topic name");
  push(ref(db,'topics'),{topicName:name,author:"Anonymous",timestamp:Date.now()});
  topicNameInput.value='';
});

// ---------- Topic Modal ----------
window.openTopic=function(topicId){
  currentTopicId=topicId;
  const topic=topicsCache[topicId];
  topicModalName.innerText=topic.topicName;
  topicModal.classList.remove('hidden');
  deleteAllPostsContainer.style.display=(topic.author===currentUser.uid)?'block':'none';
  newPostContent.value=''; editorStatus.innerText='';
  renderPosts();
}
closeTopicModal.addEventListener('click',()=>{topicModal.classList.add('hidden'); currentTopicId=null;});

// ---------- Posts ----------
function renderPosts(){
  const topic=topicsCache[currentTopicId];
  if(!topic) return;
  const posts=topic.posts?Object.entries(topic.posts).map(([id,p])=>({id,...p})):[];  
  posts.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
  postsContainer.innerHTML = posts.map(p=>{
    const canDelete=(p.authorUid===currentUser.uid)||(topic.author===currentUser.uid);
    return `<div class="bg-gray-50 p-3 rounded shadow">
      <div class="flex justify-between items-start">
        <div>
          <div class="font-medium text-gray-700">${escapeHtml(p.authorName||"Anonymous")}</div>
          <div class="text-gray-400 text-sm">${timeAgo(p.timestamp||0)}</div>
        </div>
        ${canDelete?`<button onclick="deletePost('${p.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-sm">Delete</button>`:''}
      </div>
      <div class="mt-2 text-gray-700">${escapeHtml(p.content)}</div>
    </div>`;
  }).join('');
}

postBtn.addEventListener('click',()=>{
  const val=newPostContent.value.trim();
  if(!val) return alert("Enter post content");
  push(ref(db,`topics/${currentTopicId}/posts`),{authorName:"Anonymous",authorUid:currentUser.uid,content:val,timestamp:Date.now()});
  newPostContent.value=''; editorStatus.innerText="Posted";
});

deleteAllPostsBtn.addEventListener('click',()=>{
  if(!confirm("Delete all posts in this topic?")) return;
  remove(ref(db,`topics/${currentTopicId}/posts`));
});

function deletePost(postId){
  if(!confirm("Delete this post?")) return;
  remove(ref(db,`topics/${currentTopicId}/posts/${postId}`));
}

// ---------- Drafts ----------
draftsBtn.addEventListener('click',()=>{draftsPanel.style.transform='translateX(0)'; renderDraftsList();});
closeDrafts.addEventListener('click',()=>{draftsPanel.style.transform='translateX(100%)';});
newDraftBtn.addEventListener('click',()=>{
  currentEditingDraftId=null; newPostContent.value=''; editorStatus.innerText='New Draft';
  draftsPanel.style.transform='translateX(100%)';
  topicModal.classList.remove('hidden');
});
saveDraftBtn.addEventListener('click',()=>{
  const val=newPostContent.value.trim();
  if(!val) return alert("Enter content");
  if(currentEditingDraftId){
    update(ref(db,`drafts/${currentUser.uid}/${currentEditingDraftId}`),{content:val,timestamp:Date.now()});
  }else{
    push(ref(db,`drafts/${currentUser.uid}`),{content:val,timestamp:Date.now()});
  }
  editorStatus.innerText="Saved Draft";
});

function renderDraftsList(){
  const arr = Object.entries(draftsCache||{}).map(([id,d])=>({id,...d}));
  if(arr.length===0){emptyDrafts.style.display='block'; draftsList.innerHTML=''; return;}
  emptyDrafts.style.display='none';
  draftsList.innerHTML = arr.map(d=>{
    return `<div class="bg-gray-50 p-3 rounded shadow flex justify-between items-start">
      <div class="flex-1 cursor-pointer" onclick="editDraft('${d.id}')">${escapeHtml(d.content)}</div>
      <button onclick="deleteDraft('${d.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
    </div>`;
  }).join('');
}

window.editDraft=function(draftId){
  currentEditingDraftId=draftId;
  newPostContent.value=draftsCache[draftId].content;
  topicModal.classList.remove('hidden');
  draftsPanel.style.transform='translateX(100%)';
  editorStatus.innerText='Editing Draft';
}
window.deleteDraft=function(draftId){ remove(ref(db,`drafts/${currentUser.uid}/${draftId}`)); }

</script>
<script>lucide.createIcons();</script>
</body>
</html>
